name: ëŒ€í•™ ê³µì§€ì‚¬í•­ í¬ë¡¤ë§

# ì‹¤í–‰ ì¡°ê±´
on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 6ì‹œ)
  schedule:
    - cron: '0 0,3,6,9,12 * * 1-6'  # UTC ê¸°ì¤€ (í•œêµ­ì‹œê°„ -9ì‹œê°„)
  
  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:
    inputs:
        mode:
          description: 'ì‹¤í–‰ ëª¨ë“œ'
          required: true
          default: 'crawl'
          type: choice
          options:
            - crawl      # ì¼ë°˜ í¬ë¡¤ë§
            - test       # í…ŒìŠ¤íŠ¸ (ë””ë²„ê¹…)
            - debug      # ìƒì„¸ ë””ë²„ê¹…

permissions:
  contents: write
  
jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. Python ì„¤ì¹˜
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. ìºì‹œ ì„¤ì • (ì†ë„ í–¥ìƒ)
    - name: ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
    
    # 4. íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      run: |
        if [ "${{ github.event.inputs.mode }}" = "test" ]; then
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì‹¤í–‰"
          python test_crawl.py
        elif [ "${{ github.event.inputs.mode }}" = "debug" ]; then
          echo "ğŸ” ë””ë²„ê·¸ ëª¨ë“œ ì‹¤í–‰"
          python debug_crawl.py
        else
          echo "ğŸ¤– ì¼ë°˜ í¬ë¡¤ë§ ì‹¤í–‰"
          python main.py
        fi
    
    # í¬ë¡¤ë§ ëª¨ë“œì¼ ë•Œë§Œ ê²°ê³¼ ì €ì¥
    - name: ê²°ê³¼ ì €ì¥
      if: github.event.inputs.mode == 'crawl' || github.event.inputs.mode == ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git pull origin main
        git add data/
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ğŸ¤– í¬ë¡¤ë§ ê²°ê³¼ ì—…ë°ì´íŠ¸: $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
